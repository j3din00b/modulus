# SPDX-FileCopyrightText: Copyright (c) 2023 - 2024 NVIDIA CORPORATION & AFFILIATES.
# SPDX-FileCopyrightText: All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This CI runs on pull requests and uses testmon to skip tests
# that don't have changed dependencies based on the nightly cache.
# The tests run here will only use UV.

# TO DO: THE COVERAGE LIMIT IS VERY LOW, BECAUSE THIS IS NOT USING GPU TESTS OR
# THE DATA-DRIVEN TESTS.  RAISE THIS UP AGAIN EVENTUALLY.

name: Pull Request Github CI
on:
  push:
    branches:
      - "pull-request/[0-9]+"
  workflow_dispatch:
    # Allow manual triggering for debugging the CI.

# Container image used across all jobs - update this single value to change everywhere
# Note: env context not available in container.image, so we hardcode the value
jobs:
  # Stage 1: Build and cache the environment
  build-environment:
    name: Build Environment
    runs-on: linux-amd64-cpu8
    container:
      image: nvcr.io/nvidia/pytorch:25.01-py3

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 5
        max_attempts: 3
        command: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Restore uv cache
      id: cache-uv-restore
      uses: actions/cache/restore@v4
      with:
        path: .venv
        key: uv-env-pr-latest

    - name: Install package with uv
      if: steps.cache-uv-restore.outputs.cache-hit != 'true'
      run: |
        # Install core dependencies and development group
        uv sync --group dev --preview-features extra-build-dependencies

    - name: Free disk space before caching
      if: steps.cache-uv-restore.outputs.cache-hit != 'true'
      run: |
        rm -rf ~/.cache/uv
        df -h

    - name: Delete old environment cache
      if: steps.cache-uv-restore.outputs.cache-hit != 'true'
      run: |
        gh cache delete "uv-env-pr-latest" || true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Save environment to cache
      if: steps.cache-uv-restore.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: .venv
        key: uv-env-pr-latest

  # Stage 2: Run testmon tests
  testmon:
    name: Testmon
    needs: build-environment
    runs-on: linux-amd64-gpu-h100-latest-1
    container:
      image: nvcr.io/nvidia/pytorch:25.01-py3

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 5
        max_attempts: 3
        command: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Restore environment from cache
      uses: actions/cache/restore@v4
      with:
        path: .venv
        key: uv-env-pr-latest
        fail-on-cache-miss: true

    - name: Restore testmon database from cache
      uses: actions/cache/restore@v4
      with:
        path: |
          .testmondata
          .testmondata-shm
          .testmondata-wal
        key: testmon-nightly-latest

    - name: Run core tests (with testmon)
      run: |
        uv run python -m pytest --testmon --ignore-glob="*docs*" --ignore-glob="*examples*"

  # Stage 3: Run coverage tests and upload artifacts
  coverage:
    name: Coverage
    needs: build-environment
    runs-on: linux-amd64-gpu-h100-latest-1
    container:
      image: nvcr.io/nvidia/pytorch:25.01-py3

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 5
        max_attempts: 3
        command: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: Restore environment from cache
      uses: actions/cache/restore@v4
      with:
        path: .venv
        key: uv-env-pr-latest
        fail-on-cache-miss: true

    - name: Restore testmon database from cache
      uses: actions/cache/restore@v4
      with:
        path: |
          .testmondata
          .testmondata-shm
          .testmondata-wal
        key: testmon-nightly-latest

    - name: Restore nightly coverage baseline from cache
      id: cache-coverage-restore
      uses: actions/cache/restore@v4
      with:
        path: .coverage*
        key: coverage-nightly-latest

    - name: Run core tests for coverage report (testmon-selected)
      run: |
        # Use testmon to only run tests affected by changes, with coverage
        uv run coverage run --rcfile='test/coverage.pytest.rc' -m pytest --testmon --ignore-glob="*docs*" --ignore-glob="*examples*"

    - name: Run doc tests (testmon not supported for doctests)
      run: |
        uv run coverage run --rcfile='test/coverage.docstring.rc' -m pytest --doctest-modules physicsnemo/ --ignore-glob="*internal*" --ignore-glob="*experimental*"

    - name: Merge coverage reports
      run: |
        # List all coverage files being combined
        echo "Coverage files to combine:"
        ls -la .coverage* 2>/dev/null || echo "No coverage files found"

        # Combine all .coverage* files
        uv run coverage combine

        uv run coverage report --show-missing --omit="*test*" --omit="*internal*" --omit="*experimental*" --fail-under=45
        uv run coverage html
        uv run coverage xml -o coverage.xml

    - name: Upload coverage HTML report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-pr
        path: htmlcov/
        retention-days: 7
